# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.
orbs:
  # Declare a dependency on the welcome-orb
  welcome: circleci/welcome-orb@0.4.1
  inline_example:
    executors:
      default:
        description: |
          Custom Docker image with pre-packaged welcome orb commands
        docker:
        - image: google/cloud-sdk
    jobs:
      my_inline_job:
        description: |
          Example of a inline orb creation.
        # executor: default
        machine: true
        parameters:
          greeting_name:
            description: # a helpful description
            type: string
            default: josh
          zone:
            description: # a helpful description
            type: string
            default: us-west2-c
          gcloud-project:
            description: # a helpful description
            type: string
            default: onec-prod
          ips:
            description: # a helpful description
            type: string
            default: 0.0.0.0/32
        steps:
          - my_inline_command:
              greeting_name: <<parameters.greeting_name>>
          - check_ip
          - cluster_update:
              zone: <<parameters.zone>>
              gcloud-project: <<parameters.gcloud-project>>
              ips: <<parameters.ips>>
    commands:
      my_inline_command:
        parameters:
          greeting_name:
            type: string
        steps:
          - run: echo "hello <<parameters.greeting_name>>, from the inline command"
      check_ip:
        steps:
          - run:
              name: Getting circleci ip
              command: |
                apt-get install wget
                circle_ci_ip=$(wget -qO- http://checkip.amazonaws.com)
                echo "Circle CI public IP is $circle_ci_ip"
      cluster_update:
        parameters:
          zone:
            type: string
          gcloud-project:
            type: string
          ips:
            type: string
        steps:
          - run:
              name: Updating White Listed IP on clusters
              command: |
                gcloud container clusters update --zone <<parameters.zone>> <<parameters.gcloud-project>> --enable-master-authorized-networks --master-authorized-networks <<parameters.ips>> 

# Orchestrate or schedule a set of jobs
workflows:
  welcome:
    jobs:
      - welcome/run
      - inline_example/my_inline_job:
          name: mybuild
          greeting_name: josh
          zone: us-west2-c 
          gcloud-project: onec-prod
          ips: 157.131.134.210/32,35.236.8.106/32,$circle_ci_ip
